<% my $file_ext = $lkey->{settings}->{file_ext} || $lkey->{settings}->{ext} || 'null'; %>

<% if($file_ext ne 'null'){ %><div style="font-style:italic;font-weight:bold;padding-bottom:20px;">Допустимые расширения:<%= $file_ext %></div><% } %>
<input type=hidden name="<%= $key %>" id="filename<%= $key %>" value="">
<div id="div<%= $key %><%= $index %>" style="padding-bottom:30px;"></div>
<input id="<%= $key %>_<%= $index %>" name="file_upload" type="file" />

<% my $login = $self->sysuser->userinfo->{login}; %>
<% my $cck = $self->sysuser->userinfo->{cck}; %>

<% my $save_msg = $lkey->{settings}->{save_msg} ? $lkey->{settings}->{save_msg} : 'Нажмите «Сохранить данные»'; %>  
<script type="text/javascript">
	jQuery('#<%= $key %>_<%= $index %>').uploadify({
			'swf'      : '/admin/js/jquery/uploadify/uploadify.swf',
  			'multi'		: false,
			'width'		: '130',
			'height'	: '20',		
  			'fileObjName' :'Filedata',
  			'buttonText' : 'Выбрать файл',
			'fileTypeExts'	:	'<%= $file_ext %>',
			'fileTypeDesc'  : 'Выбрать файл',  
			'formData' : {'do':'file_upload_tmp', 'lfield': '<%= $key %>', 'index' : '<%= $index %>', 'userlogin' : '<%= $login %>', 'cck' : '<%= $cck %>' },
    		'uploader'    : '<%= $controller_url %>',
    		'auto'      : true,
    		'onUploadSuccess' : function(file, data, response){
    			var res = data.split('|');
    			jQuery('#filename<%= $key %>').val(res[0]);
				if( file['type'] && jQuery.inArray(file['type'], ('.jpg', '.gif', '.png', '.jpeg') ) ){
	    			jQuery('#div<%= $key %><%= $index %>').html('<img style="padding:10px;" width="100" src="/admin/main/body?do=upload_tmp_thumbview&pict='+res[0]+'" /><br />' 
    				+ res[0] + ', '+ res[1] +  ' <span style=\"background-color:red;color:white;padding:3px;margin-left:15px\"><%= $save_msg %></span>');	
				} else {
					jQuery('#div<%= $key %><%= $index %>').html(res[0] + ', '+ res[1] +  ' <span style=\"background-color:red;color:white;padding:3px;margin-left:15px\"><%= $save_msg %></span>');	
				}
    			
    		}
    		
});
</script>

