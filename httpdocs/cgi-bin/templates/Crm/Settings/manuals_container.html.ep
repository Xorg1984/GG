
<div id="listings">
    <div id="listings-left">
        <ul>
        	<% foreach (@$manuals){ %>
            	<li><a href="javascript:void(0);" onClick="get_manual_items('<%= $_->{ID} %>');return false;"><%= $_->{name} %></a></li>
            <% } %>
        </ul>
    </div>
    <div id="listings-right">

    </div>
</div>

<script type="text/javascript">
$(document).ready( function () {
    $("#listings-left li").click(function(){
        if (!$(this).is(".current")) {
            $("#listings-left li").removeClass("current");
            $(this).addClass("current");
        }
        return false;
    });
	$("body").click(function(e){
		var target = $(e.target);
		if (!target.is("input") && !target.is("select") && !target.is("option")) {
			$("#listings-right td.c3").removeClass("ok").addClass("del");
		}
	});
	
	$('input[name=qsearch]').live('keypress', function(e) {
		if(e.keyCode==13) $("#search_btn").click();
	});
});

function update_manual_list_binds(){
   
    $("#listings-right td.c3").click(function(){
    	var node = $(this);
    	var item_id = $(this).parents("tr:first").attr('item_id');
    	var manual_id = $(this).parents("table:first").attr('manual_id');
    	
    	if(node.hasClass('del')){
    		if(item_id > 0 && confirm('Вы уверены что хотите удалить запись ?')){
    			save_manual_item(manual_id, item_id, true);
    		} else {
    			node.parents("tr:first").fadeOut('slow', function() {
					$(this).remove();
				});
    		}
    	}
    	
    	if(node.hasClass('ok')){
    		save_manual_item(manual_id, item_id, false);
    	}
    	
    });

    $("#listings-right input").add("#listings-right select").focus(function(e){
		$("#listings-right td.c3").removeClass("ok").addClass("del");
		    	
        $(this).closest("td").addClass("focus").end().closest("tr").find(".c3").removeClass("del").addClass("ok");
        e.stopPropagation();
    }).blur(function(){
		$(this).closest("td").removeClass("focus");
    });
   

    //.blur(function(){
	//	$(this).closest("td").removeClass("focus").end().closest("tr").find(".c3").removeClass("ok").addClass("del");
    //});
    
    $("#listings-right tr.header a").click(function(){

        if (!$(this).closest("td").is(".sort")) {
            $(this).closest("tr").find("td").removeClass("sort");
            $(this).closest("td").addClass("sort");
        } else {
            if ($(this).is(".desc")) {
                $(this).toggleClass("desc").toggleClass("asc");
            } else {
                $(this).toggleClass("asc").toggleClass("desc");
            }
        }
        
		get_manual_items();
		
        return false;
    });
}

function save_manual_item(manual_id, item_id, delete_flag){
	if(typeof(delete_flag) == 'undefined') delete_flag = false;
	var node = $("#listings-right tr[item_id="+item_id+"]");
	var data = {};
	$("input", node).add("select", node).each(function(){
		var k = $(this).attr('name');
		var v = $(this).val();
		data[k] = v;
	});
	
	data['manual_id'] = manual_id;
	data['item_id'] = item_id;
	data['delete'] = delete_flag ? 1 : 0;

	$.ajax({
		url: "/crm/settings_manuals/update_list_items",
		type: 'POST',
  		beforeSend: function(){
  			
		},
   		success: function(data){
			if(data.success){
				if(delete_flag){
					node.fadeOut('slow', function() {
						$(this).remove();
					});
				} else if(data.index){
					if($("#listings-right tr[item_id="+item_id+"]:visible").length){
						$("#listings-right tr[item_id="+item_id+"]:visible").attr('item_id', data.index);
					}
				}
			}
   		},
   		error: function(data){
   			alert('Системная ошибка, повторите попытку позже')
   		},
   		complete: function(){
   		},
   		data: data
	});
	
}

function add_manual_item_node(){
	$("#listings-right tr:first").clone().show().insertAfter( '#listings-right tr.header' );
	update_manual_list_binds();
}

function get_manual_items(manual_id){
	if(typeof(manual_id) == 'undefined'){
		var manual_id = $("#listings-right table").length ? $("#listings-right table").attr('manual_id') : 0;
	}
	var qsearch = $("input[name=qsearch]").val() || '';
	
	var sort = '';
	var sort_order = '';
	$("tr.header td.sort a").each(function(){
		sort = $(this).attr('lkey');
		sort_order = $(this).hasClass('desc') ? 'desc' : 'asc';
	})
	$.ajax({
		url: "/crm/settings_manuals/list_items",
  		beforeSend: function(){
  			
		},
   		success: function(data){
			   $("#listings-right").html(data.html)
   		},
   		error: function(data){
   			alert('Системная ошибка, повторите попытку позже')
   		},
   		complete: function(){
   			update_manual_list_binds();
   		},
   		data: {manual_id: manual_id, qsearch: qsearch, sort: sort, sort_order: sort_order}
	});
}
</script>